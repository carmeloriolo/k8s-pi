---
- name: Setup K8S Master
  hosts: master
  become: true
  tasks:
   - name: "Install prerequisites"
     ansible.builtin.apt:
      name:
       - apt-transport-https
       - ca-certificates
       - curl
      state: present

   - name: "Add Google Cloud public signing key"
     ansible.builtin.apt_key:
      url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
      state: present

   - name: "Add Kubernetes Repository"
     ansible.builtin.apt_repository:
      repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
      state: present
      filename: 'kubernetes'

   - name: "Install kubelet, kubeadm, kubectl"
     ansible.builtin.apt:
      name:
       - kubelet
       - kubeadm
       - kubectl
      state: present
      update_cache: true

   - name: "Prevent packages from being upgraded"
     ansible.builtin.dpkg_selections:
      name: "{{ item }}"
      selection: hold
     loop:
      - kubelet
      - kubeadm
      - kubectl
